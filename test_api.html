<!DOCTYPE html>
<html>
<head>
    <title>Reservation System Tester</title>
    <style>
        * { font-family: Arial, sans-serif; }
        body { margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        h2 { color: #4f46e5; border-bottom: 2px solid #4f46e5; padding-bottom: 10px; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #3730a3; }
        .output { background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
        .success { background: #dcfce7; border-color: #166534; color: #166534; }
        .error { background: #fee2e2; border-color: #991b1b; color: #991b1b; }
        .info { background: #dbeafe; border-color: #0c4a6e; color: #0c4a6e; }
        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        .status { font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Reservation System Debugger</h1>
        
        <!-- Setup Info -->
        <div class="section info">
            <h2>ðŸ“‹ Quick Checklist</h2>
            <p>âœ“ FastAPI running on http://127.0.0.1:8000</p>
            <p>âœ“ PostgreSQL database "GearShare" is running</p>
            <p>âœ“ You are logged in to GearShare (check localStorage)</p>
            <p style="margin-top: 20px; color: #666;"><strong>Instructions:</strong> Try creating a reservation through the UI first, then use these tools to debug what went wrong.</p>
        </div>

        <!-- Get Equipment -->
        <div class="section">
            <h2>1. Get Available Equipment</h2>
            <button onclick="getEquipment()">Fetch Equipment</button>
            <div id="equipment-output" class="output" style="display:none;"></div>
        </div>

        <!-- Create Reservation -->
        <div class="section">
            <h2>2. Create Test Reservation</h2>
            <div class="input-group">
                <label>Your Username:</label>
                <input type="text" id="username" placeholder="e.g., bapon" value="">
            </div>
            <div class="input-group">
                <label>Equipment ID:</label>
                <input type="number" id="equipmentId" placeholder="e.g., 1" value="1">
            </div>
            <div class="input-group">
                <label>Start Date:</label>
                <input type="date" id="startDate" value="">
            </div>
            <div class="input-group">
                <label>End Date:</label>
                <input type="date" id="endDate" value="">
            </div>
            <button onclick="createReservation()">Create Reservation</button>
            <div id="create-output" class="output" style="display:none;"></div>
        </div>

        <!-- Check Incoming -->
        <div class="section">
            <h2>3. Check Incoming Reservations (As Owner)</h2>
            <button onclick="getIncoming()">Get Incoming Reservations</button>
            <div id="incoming-output" class="output" style="display:none;"></div>
        </div>

        <!-- Check Outgoing -->
        <div class="section">
            <h2>4. Check Outgoing Reservations (As Reserver)</h2>
            <button onclick="getOutgoing()">Get Outgoing Reservations</button>
            <div id="outgoing-output" class="output" style="display:none;"></div>
        </div>

        <!-- Database Check -->
        <div class="section">
            <h2>5. Check Database Directly (Run in pgAdmin)</h2>
            <div class="output" style="background: #fef3c7;">
                <pre>-- Check if reservation table exists
SELECT * FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'reservation';

-- View all reservations
SELECT * FROM reservation;

-- Count reservations
SELECT COUNT(*) as total_reservations FROM reservation;

-- Check foreign key constraints
SELECT * FROM information_schema.table_constraints 
WHERE table_name = 'reservation';</pre>
            </div>
        </div>

        <!-- Logs -->
        <div class="section">
            <h2>ðŸ“œ Console Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <div id="logs-output" class="output info"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs-output');
            const time = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs-output').innerHTML = '';
        }

        function showOutput(elementId, data, isError = false) {
            const elem = document.getElementById(elementId);
            elem.style.display = 'block';
            elem.className = 'output ' + (isError ? 'error' : 'success');
            elem.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function getEquipment() {
            log('Fetching equipment...', 'info');
            try {
                const response = await fetch(`${API_BASE}/equipment/`);
                const data = await response.json();
                log(`âœ“ Got ${data.length} equipment items`, 'success');
                showOutput('equipment-output', data);
            } catch (err) {
                log(`âœ— Error: ${err.message}`, 'error');
                showOutput('equipment-output', { error: err.message }, true);
            }
        }

        async function createReservation() {
            const username = document.getElementById('username').value;
            const equipmentId = parseInt(document.getElementById('equipmentId').value);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!username || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
            }

            log(`Creating reservation: Equipment ${equipmentId}, ${startDate} to ${endDate}`, 'info');

            try {
                const response = await fetch(`${API_BASE}/reservation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'reserver_username': username
                    },
                    body: JSON.stringify({
                        equipment_id: equipmentId,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                log(`Response status: ${response.status}`, 'info');
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ“ Reservation created with ID ${data.reservation_id}`, 'success');
                    showOutput('create-output', data);
                } else {
                    log(`âœ— Error: ${data.detail}`, 'error');
                    showOutput('create-output', data, true);
                }
            } catch (err) {
                log(`âœ— Network error: ${err.message}`, 'error');
                showOutput('create-output', { error: err.message }, true);
            }
        }

        async function getIncoming() {
            const username = document.getElementById('username').value || 'bapon';
            log(`Fetching incoming reservations for: ${username}`, 'info');
            try {
                const response = await fetch(`${API_BASE}/reservation/owner/${username}`);
                const data = await response.json();
                log(`âœ“ Got ${data.length} incoming reservations`, 'success');
                showOutput('incoming-output', data);
            } catch (err) {
                log(`âœ— Error: ${err.message}`, 'error');
                showOutput('incoming-output', { error: err.message }, true);
            }
        }

        async function getOutgoing() {
            const username = document.getElementById('username').value || 'bapon';
            log(`Fetching outgoing reservations for: ${username}`, 'info');
            try {
                const response = await fetch(`${API_BASE}/reservation/reserver/${username}`);
                const data = await response.json();
                log(`âœ“ Got ${data.length} outgoing reservations`, 'success');
                showOutput('outgoing-output', data);
            } catch (err) {
                log(`âœ— Error: ${err.message}`, 'error');
                showOutput('outgoing-output', { error: err.message }, true);
            }
        }

        // Set default dates
        window.addEventListener('load', () => {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const inFiveDays = new Date(today);
            inFiveDays.setDate(inFiveDays.getDate() + 5);

            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = inFiveDays.toISOString().split('T')[0];

            // Try to get username from localStorage
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                if (user && user.name) {
                    document.getElementById('username').value = user.name;
                    log(`âœ“ Found logged-in user: ${user.name}`, 'success');
                }
            } catch (e) {
                log('âš  Could not read user from localStorage', 'info');
            }
        });
    </script>
</body>
</html>
